<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="styles.css" />

    <script type="text/javascript" src="freightMethods.js"></script>
    <script type="text/javascript" src="elementBuilders.js"></script>
    <script type="text/javascript" src="smartwayBins.js"></script>
    <script type="text/javascript" src="performanceProfile.js"></script>
</head>

<body>
    <form class="center">

        <fieldset id="movingMethodsFieldset">
            <legend>Moving Methods</legend>
        </fieldset>

        <fieldset id="activityQuantityFieldSet">
            <legend>Movement Activity</legend>
            <label>
                Units:
                <select id="unitsSelect" onchange="onUnitsChange()" class="center">
                    <option value="Miles">Miles</option>
                    <option value="Ton-Miles">Ton-Miles</option>
                </select>
            </label>
            <table style="width:100%">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Movement Amount</th>
                    </tr>
                </thead>
                <tbody id="activityQuantityTable">
                </tbody>
            </table>
        </fieldset>
        <fieldset id="performanceRankingsFieldset">
            <legend>Performance Rankings</legend>
            <label>
                Detailed Rankings (optional)
                <input type="checkbox" onchange="onDetailedChange(this)" id="doDetailed" />
            </label>
            <table style="width:100%">
                <thead id="currentSimpleHeader">
                    <tr>
                        <th>Type</th>
                        <th>General Performance Level</th>
                    </tr>
                </thead>
                <thead id="currentDetailedHeader" style="display:none">
                    <tr>
                        <th>Type</th>
                        <th>% NON</th>
                        <th>% Bin 5</th>
                        <th>% Bin 4</th>
                        <th>% Bin 3</th>
                        <th>% Bin 2</th>
                        <th>% Bin 1</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="activityPerformanceTable"></tbody>
            </table>
        </fieldset>
        <fieldset id="emissionsOutputFieldSet">
            <legend>Emissions</legend>
            <table style="width:100%">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>CO2 (g)</th>
                        <th>NOX (g)</th>
                        <th>PM (g)</th>
                    </tr>
                </thead>
                <tbody id="emissionsOutputTable"></tbody>
            </table>
        </fieldset>
        <fieldset id"targetPerformanceFieldSet">
            <legend>Target Performance Rankings</legend>
            <table style="width:100%">
                <thead id="targetSimpleHeader">
                    <tr>
                        <th>Type</th>
                        <th>General Performance Level</th>
                    </tr>
                </thead>
                <thead id="targetDetailedHeader" style="display:none">
                    <tr>
                        <th>Type</th>
                        <th>% NON</th>
                        <th>% Bin 5</th>
                        <th>% Bin 4</th>
                        <th>% Bin 3</th>
                        <th>% Bin 2</th>
                        <th>% Bin 1</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="targetPerformanceTable"></tbody>
            </table>
        </fieldset>

    </form>

    <script type="text/javascript">

        // The object representing all current activity/performance levels
        var currentProfile = new PerformanceProfile(freightMethods,
            "activityPerformanceTable", "currentSimpleHeader",
            "currentDetailedHeader", updateEmissionsUI);
        var targetProfile = new PerformanceProfile(createFreightMethods(),
        "targetPerformanceTable", "targetSimpleHeader", "targetDetailedHeader", updateSavingsUI)

        // Update the "active" boolean of each method, and update the UI
        function onSelectedFreightMethodsChange() {
            let label = document.getElementById("selectedMethodsOutput");
            //label.textContent = "othertext"
            let selected = [];
            let elements = document.getElementById("movingMethodsFieldset").getElementsByTagName("input")
            for (let i = 0, element; element = elements[i++];) {
                if (element.type === "checkbox" && element.checked) {
                    let text = element.parentElement.textContent;
                    selected.push(text);
                }
            }

            //Update the model for all of the methods
            updateActiveMethods(selected);
            updateQuantityInputUI();

            let units = document.getElementById("unitsSelect").value;
            currentProfile.bins = smartwayBinJSON[units];
            currentProfile.updateInputUI();
            targetProfile.bins = smartwayBinJSON[units];
            targetProfile.updateInputUI();

            updateEmissionsCalculations();
        }

        function onUnitsChange() {
            currentProfile.bins = smartwayBinJSON[event.currentTarget.value];
            updateEmissionsCalculations();
        }

        function onDetailedChange(doDetailed)
        {
            let units = document.getElementById("unitsSelect");
            currentProfile.bins = smartwayBinJSON[units];
            currentProfile.setDetailed(doDetailed.checked);
            targetProfile.setDetailed(doDetailed.checked);
        }

        let element = document.getElementById("movingMethodsFieldset");

        // Populate moving methods checkboxes
        for (let i = 0; i < freightMethods.length; ++i) {
            let box = createCheckBox(freightMethods[i].type);
            box.addEventListener("click", onSelectedFreightMethodsChange);
            element.appendChild(box);
        }


        function updateActiveMethods(activeMethods) {
            for (let i = 0; i < freightMethods.length; ++i) {
                let method = freightMethods[i];
                if (activeMethods.includes(method.type)) {
                    method.active = true;
                    targetProfile.methods[i].active = true;
                }
                else {
                    method.active = false;
                }
            }
        }

        function updateQuantityInputUI() {

            let activityQuantityTable = document.getElementById("activityQuantityTable")
            // Clear out table
            while (activityQuantityTable.firstChild) {
                activityQuantityTable.removeChild(activityQuantityTable.firstChild)
            }
            for (let i = 0; i < freightMethods.length; ++i) {
                var method = freightMethods[i];
                if (method.active) {
                    let label = document.createTextNode(method.type)
                    label.textContent = method.type;
                    var input = document.createElement("input")
                    input.type = "number";
                    input.min = 0;
                    input.onchange = function () {
                        freightMethods[i].activityQuantity = event.currentTarget.value;
                        updateEmissionsCalculations();
                    };
                    input.value = method.activityQuantity;
                    let row = createTableRow(label, input);

                    activityQuantityTable.appendChild(row)
                }
            }
        }

        function updateCurrentInputUI() {
            currentProfile.updateInputUI()
            targetProfile.updateInputUI();
        }

        function roundToTwo(num) {
            return +(Math.round(num + "e+2") + "e-2");
        }

        function updateEmissionsUI() {
            activeFreightMethods = [];
            freightMethods.forEach(function (method) {
                if (method.active) activeFreightMethods.push(method);
            })

            let table = document.getElementById("emissionsOutputTable")
            while (table.firstChild) {
                table.removeChild(table.firstChild);
            }

            for (let i = 0; i < activeFreightMethods.length; ++i) {
                let method = activeFreightMethods[i];
                let tableRow = createTableRow(
                    createTableCell(method.type),
                    createTableCell(roundToTwo(method.CO2).toLocaleString()),
                    createTableCell(roundToTwo(method.NOX).toLocaleString()),
                    createTableCell(roundToTwo(method.PM).toLocaleString()));

                table.appendChild(tableRow)
            }
        }

        function updateSavingsUI()
        {

        }

        function updateEmissionsCalculations() {

            let units = document.getElementById("unitsSelect").value;
            currentProfile.bins = smartwayBinJSON[units];
            let activeFreightMethods = [];
            freightMethods.forEach(function (method) {
                if (method.active) {
                    activeFreightMethods.push(method);
                }
            })

            if (document.getElementById("doDetailed").checked) {
                currentProfile.updateEmissionsDetailed();
            }
            else {
                currentProfile.updateEmissionsSimple();
            }

            updateEmissionsUI();
        }
    </script>
</body>

</html>