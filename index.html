<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="styles.css" />
    <!--- JQUERY -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <script type="text/javascript" src="freightMethods.js"></script>
    <script type="text/javascript" src="elementBuilders.js"></script>
    <script type="text/javascript" src="performanceProfile.js"></script>
    <script type="text/javascript" src="comboBox.js"></script>
    <style>
        .custom-combobox {
          position: relative;
          display: inline-block;
        }
        .custom-combobox-toggle {
          position: absolute;
          top: 0;
          bottom: 0;
          margin-left: -1px;
          padding: 0;
        }
        .custom-combobox-input {
          margin: 0;
          padding: 5px 10px;
        }
        </style>
</head>

<body>
    <form class="center">

        <fieldset id="activityQuantityFieldSet">
            <legend>Movement Activity</legend>
            <p>
                <input type="button" value="+" onclick="addCurrentActivity()"/>
            </p>
            <table style="width:100%">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Movement Amount</th>
                    </tr>
                </thead>
                <tbody id="activityQuantityTable">
                </tbody>
            </table>
            <label id="totalActivityLabel" style="font-weight:bold">
                Total Activity:
            </label>
        </fieldset>
        <fieldset id="performanceRankingsFieldset">
            <legend>Performance Rankings</legend>
            <label>
                Detailed Rankings (optional)
                <input type="checkbox" onchange="onDetailedChange(this)" id="doDetailed" />
            </label>
            <table style="width:100%">
                <thead id="currentSimpleHeader">
                    <tr>
                        <th>Type</th>
                        <th>General Performance Level</th>
                    </tr>
                </thead>
                <thead id="currentDetailedHeader" style="display:none">
                    <tr>
                        <th>Type</th>
                        <th>% NON</th>
                        <th>% Bin 5</th>
                        <th>% Bin 4</th>
                        <th>% Bin 3</th>
                        <th>% Bin 2</th>
                        <th>% Bin 1</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="activityPerformanceTable"></tbody>
            </table>
        </fieldset>
        <fieldset id="emissionsOutputFieldSet">
            <legend>Emissions</legend>
            <table style="width:100%">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>CO2 (g)</th>
                        <th>NOX (g)</th>
                        <th>PM (g)</th>
                    </tr>
                </thead>
                <tbody id="emissionsOutputTable"></tbody>
            </table>
        </fieldset>
        <fieldset id="targetPerformanceFieldSet">
            <legend>Target Performance Rankings</legend>
            <table style="width:100%">
                <thead id="targetSimpleHeader">
                    <tr>
                        <th>Type</th>
                        <th>General Performance Level</th>
                    </tr>
                </thead>
                <thead id="targetDetailedHeader" style="display:none">
                    <tr>
                        <th>Type</th>
                        <th>% NON</th>
                        <th>% Bin 5</th>
                        <th>% Bin 4</th>
                        <th>% Bin 3</th>
                        <th>% Bin 2</th>
                        <th>% Bin 1</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="targetPerformanceTable"></tbody>
            </table>
        </fieldset>
        <fieldset id="savingsFieldSet">
            <legend>Final Emissions/Emissions Saved</legend>
            <legend>Emissions</legend>
            <label>Metric:
                <select id="savingsOutputSelect" onchange="updateSavingsUI()">
                    <option value="Grams">Final Grams</option>
                    <option value="Grams Saved">Grams Saved</option>
                    <option value="% Saved">% Saved</option>
                    <script type="text/javascript">
                        var savingsOutputTypes = [
                            "Grams",
                            "Grams Saved",
                            "% Saved"
                        ];
                        var savingsOutputOperations = [
                            function (previous, target) { return target; },
                            function (previous, target) { return previous - target; },
                            function (previous, target) { return 100 * ((previous - target) / previous); }
                        ];
                    </script>
                </select>
            </label>
            <table style="width:100%">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>CO2</th>
                        <th>NOX</th>
                        <th>PM</th>
                    </tr>
                </thead>
                <tbody id="savingsTable"></tbody>
            </table>
        </fieldset>

    </form>

    <script type="text/javascript">

        // The object representing all current activity/performance levels
        var currentProfile = new PerformanceProfile(freightMethods,
            "activityPerformanceTable", "currentSimpleHeader",
            "currentDetailedHeader", onProfileChanged);
        var targetProfile = new PerformanceProfile(createFreightMethods(),
            "targetPerformanceTable", "targetSimpleHeader", "targetDetailedHeader", onProfileChanged)

        var smartwayBinJSON = undefined;

        $(function () {

            $.getJSON("smartwayBins.json", function (data) {
                smartwayBinJSON = data;
                currentProfile.bins = smartwayBinJSON.Miles;
                targetProfile.bins = smartwayBinJSON.Miles;
            });

        })

        function getAvailableActivities() {
            let available = freightMethods.slice();
            freightMethods.forEach(function (method) {
                if (method.active) available.splice(available.indexOf(method), 1);
            });
            return available;
        }

        function addCurrentActivity() {
            let $typeSelect = $('<select></select>');
            $typeSelect.empty().append(function () {
                let output = '';
                getAvailableActivities().forEach(function (activity) {
                    output += "<option>" + activity.type + "</option>";
                });
                return output;
            });
            $("#activityQuantityTable").append("<tr><td></td></tr>");
            $("#activityQuantityTable").find('td').last().append($typeSelect);
            $typeSelect.combobox();
        }

        function onProfileChanged() {
            updateEmissionsCalculations();
            updateEmissionsUI();
            updateSavingsUI();
        }

        function onTargetProfileChanged() {
            updateEmissionsCalculations();
            updateEmissionsUI();
            updateSavingsUI();
        }

        function onUnitsChange() {
            currentProfile.bins = smartwayBinJSON[event.currentTarget.value];
            targetProfile.bins = smartwayBinJSON[event.currentTarget.value];
            updateTotalActivity();
            onProfileChanged();
        }

        function onDetailedChange(doDetailed) {
            let units = $("#unitsSelect").val();
            currentProfile.bins = smartwayBinJSON[units];
            targetProfile.bins = smartwayBinJSON[units];
            currentProfile.setDetailed(doDetailed.checked);
            targetProfile.setDetailed(doDetailed.checked);
        }

        function updateActiveMethods(activeMethods) {
            for (let i = 0; i < freightMethods.length; ++i) {
                let method = freightMethods[i];
                if (activeMethods.includes(method.type)) {
                    method.active = true;
                    targetProfile.methods[i].active = true;
                }
                else {
                    method.active = false;
                    targetProfile.methods[i].active = false;
                }
            }
        }

        function updateQuantityInputUI() {

            let activityQuantityTable = document.getElementById("activityQuantityTable")
            $("#activityQuantityTable").empty();
            for (let i = 0; i < freightMethods.length; ++i) {
                var method = freightMethods[i];
                if (method.active) {
                    let label = document.createTextNode(method.type)
                    label.textContent = method.type;
                    var input = document.createElement("input")
                    input.type = "number";
                    input.min = 0;
                    input.onchange = function () {
                        let value = event.currentTarget.value;
                        freightMethods[i].activityQuantity = value;
                        targetProfile.methods[i].activityQuantity = value;
                        updateTotalActivity();
                        onProfileChanged();
                    };
                    input.value = method.activityQuantity;
                    let row = createTableRow(label, input);

                    activityQuantityTable.appendChild(row)
                }
            }
        }

        function updatePerformanceInputUI() {
            currentProfile.updateInputUI()
            targetProfile.updateInputUI();
        }

        function roundToTwo(num) {
            return +(Math.round(num + "e+2") + "e-2");
        }

        function updateTotalActivity() {
            activeFreightMethods = [];
            freightMethods.forEach(function (method) {
                if (method.active) activeFreightMethods.push(method);
            })
            let total = 0;
            for (let i = 0; i < activeFreightMethods.length; ++i) {
                total += Number(activeFreightMethods[i].activityQuantity);
            }
            let totalOutput = document.getElementById("totalActivityLabel")
            let units = $('#unitsSelect').val();
            totalOutput.textContent = "Total Activity: " + total + " " + units;
        }

        function updateEmissionsUI() {
            activeFreightMethods = [];
            // Get active methods from all current freightmethods
            freightMethods.forEach(function (method) {
                if (method.active) activeFreightMethods.push(method);
            })

            let table = document.getElementById("emissionsOutputTable")

            $("#emissionsOutputTable").empty();

            // Add row for emissions for each type
            for (let i = 0; i < activeFreightMethods.length; ++i) {
                let method = activeFreightMethods[i];
                let tableRow = createTableRow(
                    createTableCell(method.type),
                    createTableCell(roundToTwo(method.CO2).toLocaleString()),
                    createTableCell(roundToTwo(method.NOX).toLocaleString()),
                    createTableCell(roundToTwo(method.PM).toLocaleString()));

                table.appendChild(tableRow)
            }
        }

        function updateSavingsUI() {

            let type = document.getElementById("savingsOutputSelect").value;
            let outputFunction =
                savingsOutputOperations[savingsOutputTypes.indexOf(type)];

            let table = document.getElementById("savingsTable");

            $("#savingsTable").empty();

            // Go through each method to calculate savings
            for (let i = 0; i < freightMethods.length; ++i) {
                if (!freightMethods[i].active) { continue; }

                let currentMethod = freightMethods[i];
                let targetMethod = targetProfile.methods[i];

                let outputCO2 = outputFunction(currentMethod.CO2, targetMethod.CO2);
                let outputNOX = outputFunction(currentMethod.NOX, targetMethod.NOX);
                let outputPM = outputFunction(currentMethod.PM, targetMethod.PM);

                let tableRow = createTableRow(
                    createTableCell(currentMethod.type),
                    createTableCell(roundToTwo(outputCO2).toLocaleString()),
                    createTableCell(roundToTwo(outputNOX).toLocaleString()),
                    createTableCell(roundToTwo(outputPM).toLocaleString())
                );
                table.appendChild(tableRow);
            }

        }

        function updateEmissionsCalculations() {

            if ($("#doDetailed:checked").length > 0) {
                currentProfile.updateEmissionsDetailed();
                targetProfile.updateEmissionsDetailed();
            }
            else {
                currentProfile.updateEmissionsSimple();
                targetProfile.updateEmissionsSimple();
            }
        }
    </script>
</body>

</html>