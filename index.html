<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="jquery-ui/jquery-ui.js"></script>
    <link rel="stylesheet" href="jquery-ui/jquery-ui.css">

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>

    <script type="text/javascript" src="freightMethods.js"></script>
    <script type="text/javascript" src="elementBuilders.js"></script>
    <script type="text/javascript" src="performanceProfile.js"></script>
    <script type="text/javascript" src="comboBox.js"></script>
    <script type="text/javascript" src="activityProfile.js"></script>
    <script type="text/javascript" src="graphs.js"></script>
</head>

<body>
    <div id='inputColumn' class="column">
        <div id="tabs" class="tab">
            <button id='currentTab' class="tablinks">
                Current Carrier Usage
            </button>
            <button id='targetTab' class="tablinks">
                Target/Goal Carrier Usage
            </button>
            <button id='settingsTab' class="tablinks" style="float:right">Visualization Settings</button>
        </div>
        <div id="tabCurrent" class="tabcontent">
            <p class="center">
                <button id="addCurrentActivity">Add Carrier Type</button>
            </p>
            <fieldset id="activityQuantityDiv" class="center">
                <legend>Current Movement Activity</legend>
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Movement Amount</th>
                            <th>Movement Units</th>
                        </tr>
                    </thead>
                    <tbody id="activityQuantityTable">
                    </tbody>
                </table>
            </fieldset>
            <fieldset id="currentPerformanceDiv" class="center">
                <legend>Performance Rankings</legend>
                <label>
                    Detailed Rankings (optional)
                    <input type="checkbox" onchange="onDetailedChange(this)" id="doDetailed" />
                </label>
                <table style="width:100%">
                    <thead id="currentSimpleHeader">
                        <tr>
                            <th>Type</th>
                            <th>General Performance Level</th>
                        </tr>
                    </thead>
                    <thead id="currentDetailedHeader" style="display:none">
                        <tr>
                            <th>Type</th>
                            <th>% NON</th>
                            <th>% Bin 5</th>
                            <th>% Bin 4</th>
                            <th>% Bin 3</th>
                            <th>% Bin 2</th>
                            <th>% Bin 1</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="activityPerformanceTable"></tbody>
                </table>
            </fieldset>
            <fieldset id="emissionsOutputDiv" class="center">
                <legend>Estimated Current Emissions</legend>
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>CO2 (g)</th>
                            <th>NOX (g)</th>
                            <th>PM (g)</th>
                        </tr>
                    </thead>
                    <tbody id="emissionsOutputTable"></tbody>
                </table>
            </fieldset>
        </div>
        <div id="tabTarget" class="tabcontent">
            <p class="center">
                <button id="addTargetActivity">Add Carrier Type</button>
            </p>
            <fieldset id="targetQuantityDiv" class="center">
                <legend>Target Movement Activity</legend>
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Movement Amount</th>
                            <th>Movement Units</th>
                        </tr>
                    </thead>
                    <tbody id="targetQuantityTable">
                    </tbody>
                </table>
            </fieldset>
            <fieldset id="targetPerformanceDiv" class="center">
                <legend>Target Performance Rankings</legend>
                <table style="width:100%">
                    <thead id="targetSimpleHeader">
                        <tr>
                            <th>Type</th>
                            <th>General Performance Level</th>
                        </tr>
                    </thead>
                    <thead id="targetDetailedHeader" style="display:none">
                        <tr>
                            <th>Type</th>
                            <th>% NON</th>
                            <th>% Bin 5</th>
                            <th>% Bin 4</th>
                            <th>% Bin 3</th>
                            <th>% Bin 2</th>
                            <th>% Bin 1</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="targetPerformanceTable"></tbody>
                </table>
            </fieldset>
            <fieldset id="savingsDiv" class="center">
                <legend>Estimated Final Emissions</legend>
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>CO2 (g)</th>
                            <th>NOX (g)</th>
                            <th>PM (g)</th>
                        </tr>
                    </thead>
                    <tbody id="savingsTable"></tbody>
                </table>
            </fieldset>
        </div>
        <div id="tabSettings" class="tabcontent">
            <fieldset id="settingsFieldset">
                <legend>Visualization Settings</legend>
                <label class="center">
                    Metric:
                    <select id="visualizationMetric" onchange="updateGraphs()">
                        <option value="raw"># Changed</option>
                        <option value="percent">% Changed</option>
                    </select>
                </label>

            </fieldset>
        </div>
    </div>
    <div class="column" id="graphColumn">
        <div id="tabs" class="tab">
            <button id='co2Tab' class="tablinks" onclick="showGraph(event, '#co2Chart')">
                CO2
            </button>
            <button id='noxTab' class="tablinks" onclick="showGraph(event, '#noxChart')">
                NOX
            </button>
            <button id='pmTab' class="tablinks" onclick="showGraph(event, '#pmChart')">
                PM 2.5
            </button>
        </div>
        <div id="co2Chart" class="tabcontent"></div>
        <div id="noxChart" class="tabcontent"></div>
        <div id="pmChart" class="tabcontent"></div>
    </div>

    <script type="text/javascript">

        function showTab(event, val) {
            $('#inputColumn').find('.tablinks').removeClass('active');
            $(event.currentTarget).addClass('active');

            $('#inputColumn').children().hide();
            $('#inputColumn').children('#tabs').show();
            if (val === 'Current') {
                $('#inputColumn').children('#tabCurrent').show();
            }
            else if (val === 'Target') {
                $('#inputColumn').children('#tabTarget').show();
            }
            else if (val === 'Settings') {
                $('#inputColumn').children('#tabSettings').show();
            }
        }
        function showGraph(event, val) {
            $('#graphColumn').find('.tablinks').removeClass('active');
            $(event.currentTarget).addClass('active');

            $('#graphColumn').children().hide();
            $('#graphColumn').children('#tabs').show();
            $('#graphColumn').children(val).show();
        }
        var savingsOutputTypes = [
            "Final Grams",
            "Grams Saved",
            "% Saved"
        ];
        var savingsOutputOperations = [
            function (previous, target) { return target; },
            function (previous, target) { return previous - target; },
            function (previous, target) {
                if (previous === 0)
                    return 0;
                else
                    return 100 * ((previous - target) / previous);
            }
        ];

        // The object representing all current performance levels
        var currentPerformanceProfile = new PerformanceProfile(Model.currentFreightMethods,
            "activityPerformanceTable", "currentSimpleHeader",
            "currentDetailedHeader", updateEmissions);
        var currentActivityProfile = new ActivityProfile("#activityQuantityTable",
            onActivityChanged, Model.currentFreightMethods);

        var targetPerformanceProfile = new PerformanceProfile(Model.targetFreightMethods,
            "targetPerformanceTable", "targetSimpleHeader", "targetDetailedHeader", updateEmissions)
        var targetActivityProfile = new ActivityProfile("#targetQuantityTable",
            onActivityChanged, Model.targetFreightMethods);

        var smartwayBinJSON = undefined;

        // Load the JSON with bin constants for Ton-Miles and Miles
        $(function () {
            // Setup event listeners
            $("#currentTab").click(function () { showTab(event, 'Current'); });
            $("#targetTab").click(function () { showTab(event, 'Target'); });
            $("#settingsTab").click(function () { showTab(event, 'Settings'); });

            $("#co2Tab").click(function () { showGraph(event, '#co2Tab'); });
            $("#noxTab").click(function () { showGraph(event, '#noxTab'); });
            $("#pmTab").click(function () { showGraph(event, '#pmTab'); });

            $('#currentTab').trigger('click');
            $('#currentTab').addClass('active');
            $('#co2Tab').trigger('click');
            $('#co2Tab').addClass('active');

            $('#addCurrentActivity').click(addCurrentActivity);
            $("#addTargetActivity").click(addTargetActivity);


            $.getJSON("smartwayBins.json", function (data) {
                smartwayBinJSON = data;
                currentPerformanceProfile.bins = smartwayBinJSON;
                targetPerformanceProfile.bins = smartwayBinJSON;
            });

        })

        // Update all of the emissions calculations and UI
        function updateEmissions() {
            updateEmissionsCalculations();
            updateEmissionsUI();
            updateSavingsUI();
        }

        // When the detailed checkbox changes
        function onDetailedChange(doDetailed) {
            let detailed = doDetailed.checked;
            currentPerformanceProfile.setDetailed(detailed);
            targetPerformanceProfile.setDetailed(detailed);
        }

        // Update the target/current performance input fields
        function updatePerformanceInputUI() {
            currentPerformanceProfile.updateInputUI();
            targetPerformanceProfile.updateInputUI();
        }

        // For output number formatting
        function roundToTwo(num) {
            return +(Math.round(num + "e+2") + "e-2");
        }

        // When the add button for current activity input is clicked
        function addCurrentActivity() {
            currentActivityProfile.addQuantityInputUI();
        }
        // When the add button for target activity input is clicked
        function addTargetActivity() {
            targetActivityProfile.addQuantityInputUI();
        }

        // When the activity input, target or current, changes. Fired by activityprofiles
        function onActivityChanged() {
            updatePerformanceInputUI();
            updateEmissions();
        }

        // Update the table for emissions
        function updateEmissionsUI() {
            activeFreightMethods = [];
            // Get active methods from all current freightmethods
            Model.currentFreightMethods.forEach(function (method) {
                if (method.active) activeFreightMethods.push(method);
            })

            let table = document.getElementById("emissionsOutputTable")

            $("#emissionsOutputTable").empty();

            let currentCO2 = 0;
            let currentNOX = 0;
            let currentPM = 0;
            // Add row for emissions for each type
            for (let i = 0; i < activeFreightMethods.length; ++i) {
                let method = activeFreightMethods[i];
                let tableRow = createTableRow(
                    createTableCell(method.type),
                    createTableCell(roundToTwo(method.CO2).toLocaleString()),
                    createTableCell(roundToTwo(method.NOX).toLocaleString()),
                    createTableCell(roundToTwo(method.PM).toLocaleString()));

                table.appendChild(tableRow);
                currentCO2 += method.CO2;
                currentNOX += method.NOX;
                currentPM += method.PM;
            }

            let currentTableRow = createTableRow(
                createTableCell("TOTAL"),
                createTableCell(roundToTwo(currentCO2).toLocaleString()),
                createTableCell(roundToTwo(currentNOX).toLocaleString()),
                createTableCell(roundToTwo(currentPM).toLocaleString()));
            currentTableRow.style.fontWeight = "bolder";
            $("#emissionsOutputTable").append($(currentTableRow));
        }

        // Update the savings table, including the calculations and totals
        function updateSavingsUI() {
            let table = document.getElementById("savingsTable");

            $("#savingsTable").empty();

            let targetCO2 = 0;
            let targetNOX = 0;
            let targetPM = 0;

            // Go through each method to calculate savings
            for (let i = 0; i < Model.currentFreightMethods.length; ++i) {

                let currentMethod = Model.currentFreightMethods[i];
                let targetMethod = Model.targetFreightMethods.find(x => x.type === currentMethod.type);

                if (!currentMethod.active && !targetMethod.active) { continue; }

                targetCO2 += targetMethod.CO2;
                targetNOX += targetMethod.NOX;
                targetPM += targetMethod.PM;

                let tableRow = createTableRow(
                    createTableCell(targetMethod.type),
                    createTableCell(roundToTwo(targetMethod.CO2).toLocaleString()),
                    createTableCell(roundToTwo(targetMethod.NOX).toLocaleString()),
                    createTableCell(roundToTwo(targetMethod.PM).toLocaleString())
                );
                table.appendChild(tableRow);

            }

            let tableRow = createTableRow(
                createTableCell("TOTAL"),
                createTableCell(roundToTwo(targetCO2).toLocaleString()),
                createTableCell(roundToTwo(targetNOX).toLocaleString()),
                createTableCell(roundToTwo(targetPM).toLocaleString())
            );
            tableRow.style.fontWeight = "bolder";
            table.appendChild(tableRow);

            updateGraphs();
        }

        function updateGraphs() {
            let metric = $("#visualizationMetric").val();

            if (metric === "raw") {
                updateGraphsRaw();
            }
        }
        function updateGraphsRaw() {

            let active = [];
            let getActive = function (method) {
                if (method.active && !active.includes(method.type)) active.push(method.type);
            }

            Model.currentFreightMethods.forEach(getActive);
            Model.targetFreightMethods.forEach(getActive);
            let yTitle = "Emissions";

            function createAllSeries(pollutant) {
                let series = [];
                active.forEach(function (val) {
                    let current =
                        Model.currentFreightMethods
                            .find(x => x.type === val)[pollutant];

                    let target =
                        Model.targetFreightMethods
                            .find(x => x.type === val)[pollutant];

                    let saved = (current - target);

                    series.push({ name: val, data: [current, target, saved] });
                });

                return series;
            }
            let CO2 = createAllSeries("CO2");
            let NOX = createAllSeries("NOX");
            let PM = createAllSeries("PM");

            BarChart("co2Chart", "CO2", "Estimated Emissions in grams",
                ["<b>Current</b>", "<b>Target</b>", "<b>Savings</b>"], yTitle, "g", CO2);
            BarChart("noxChart", "NOX", "Estimated Emissions in grams",
                ["<b>Current</b>", "<b>Target</b>", "<b>Savings</b>"], yTitle, "g", NOX);
            BarChart("pmChart", "PM 2.5", "Estimated Emissions in grams",
                ["<b>Current</b>", "<b>Target</b>", "<b>Savings</b>"], yTitle, "g", PM);
        }

        // Call the profiles calculation functions (also update the bins that they use, for redundancy)
        function updateEmissionsCalculations() {
            currentPerformanceProfile.bins = smartwayBinJSON;
            targetPerformanceProfile.bins = smartwayBinJSON;
            if ($("#doDetailed:checked").length > 0) {
                currentPerformanceProfile.updateEmissionsDetailed();
                targetPerformanceProfile.updateEmissionsDetailed();
            }
            else {
                currentPerformanceProfile.updateEmissionsSimple();
                targetPerformanceProfile.updateEmissionsSimple();
            }
        }
    </script>
</body>

</html>