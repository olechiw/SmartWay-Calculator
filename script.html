<script type="text/javascript" src="/sites/all/libraries/js/highcharts/highcharts.js"></script>
<script type="text/javascript" src="/sites/all/libraries/js/datatables-1.10.12/pdfmake/pdfmake.min.js"></script>
<script type="text/javascript" src="/sites/all/libraries/js/datatables-1.10.12/pdfmake/vfs_fonts.js"></script>
<script type="text/javascript" src="/sites/all/libraries/js/highcharts/modules/exporting.js"></script>
<script type="text/javascript" src="/sites/all/libraries/js/highcharts/modules/offline-exporting.js"></script>
<script type="text/javascript" src="https://www.epa.gov/sites/production/files/js-scripts/jspdf.min.js"></script>
<script type="text/javascript">
    function FreightMethodModel(name) {
        // The name of the movement type
        this.type = name;
        this.active = false;
        this.invalid = false;

        // The activity units (Ton-Miles or Miles) and the corresponding scalar
        this.activityUnits = "Miles";
        this.activityQuantity = 0;

        // The current calculated amounts of pollution
        this.CO2 = 0;
        this.NOX = 0;
        this.PM = 0;

        // The general ranking, 1-6 with 6 being NON
        this.smartWayGeneral = "NON";
        // The specific smartway usage, from Bin 1 to NON
        this.percentSmartWay = [0, 0, 0, 0, 0, 0];
    }

    // Constant function to create a list of every method, used as the model
    function createFreightMethods() {
        return [
            new FreightMethodModel("Auto Carrier Trucking"),
            new FreightMethodModel("Dray Trucking"),
            new FreightMethodModel("Expedited Trucking"),
            new FreightMethodModel("Flatbed Trucking"),
            new FreightMethodModel("Heavy and Bulk Trucking"),
            new FreightMethodModel("LTL/Dry Van"),
            new FreightMethodModel("Mixed Trucking"),
            new FreightMethodModel("Moving Van Trucking"),
            new FreightMethodModel("Package Delivery Trucking"),
            new FreightMethodModel("Refrigerated Trucking"),
            new FreightMethodModel("Specialty Haul Trucking"),
            new FreightMethodModel("Tanker Trucking"),
            new FreightMethodModel("TL/Dry Van"),
            new FreightMethodModel("Logistics"),
            new FreightMethodModel("Multimodal"),
            new FreightMethodModel("Rail"),
            new FreightMethodModel("Barge"),
            new FreightMethodModel("Air-Long Haul"),
            new FreightMethodModel("Air-Short Haul")
        ];
    }
    // Global freight model
    var Model = {
        NonOnlyCarriers: [
            "Rail",
            "Barge",
            "Air-Long Haul",
            "Air-Short Haul"
        ],
        CurrentCarriers: createFreightMethods(),
        TargetCarriers: createFreightMethods(),
        Bins: {}
    };

    var performanceLevels = [
        "1",
        "2",
        "3",
        "4",
        "5",
        "NON"
    ];

    // Create a table data cell from text
    function createTableCell(text) {
        return jQuery("<td>" + text + "</td>");
    }

    function createTableHeader(text) {
        return jQuery("<th>" + text + "</th>");
    }

    // Create a table row, populated with input forms, takes a variable amount of arguments
    function createTableRow() {
        var tableRow = jQuery("<tr></tr>");
        jQuery.each(arguments, function () {
            tableRow.append(jQuery(this));
        });
        return tableRow;
    }

    /*
    An object responsible for modeling performance of all carriers, and also constructing/updating a user-interface to match it
    */

    function PerformanceInputUI(freightMethods, tableID, simpleHeaderID,
        detailedHeaderID, onEmissionsUpdate) {
        // DOM Object for where to put the UI
        this.table = jQuery(tableID);
        this.methods = freightMethods;
        this.doDetailed = false;

        this.simpleHeader = jQuery(simpleHeaderID);
        this.detailedHeader = jQuery(detailedHeaderID);
        jQuery(this.detailedHeader).hide();

        this.onEmissionsUpdate = onEmissionsUpdate;

        // Toggle whether to do a detailed or simple input
        this.setDetailed = function (detailed) {
            if (detailed) {
                this.simpleHeader.hide();
                this.detailedHeader.show();
            } else {
                this.simpleHeader.show();
                this.detailedHeader.hide();
            }
            this.doDetailed = detailed;

            this.updateInputUI();
        };

        // Update the input for performance, redoing every row of the table
        this.updateInputUI = function () {
            // Clear table
            jQuery(this.table).empty();

            // For a detailed NON-only row,such as barge, creates 6 readonly inputs
            var detailedNONRowCreator = function (method) {
                var output = "<tr>";
                output += "<th>" + method.type + "</th>";
                output +=
                    '<td><input style="width:55px;" value="100" min="0" max="100" maxlength="3" readOnly="true" type="number"/></td>';
                for (var i = 0; i < 6; ++i)
                    output +=
                    '<td><input style="width:55px;" value="0" readOnly="true" type="number" min="0" max="100" maxlength="3"/></td>';
                output += "</tr>";
                return jQuery(output);
            };
            // For a simple NON-only row,such as barge, creates a select with only 1 option
            var simpleNONRowCreator = function (method) {
                var output = "<tr><th>" + method.type + "</th><td>";
                output += '<select class="form-select"><option value="NON">NON-SmartWay</option></select>';
                output += "</td></tr>";
                return jQuery(output);
            };
            var profile = this;
            // Function builder for when a detailed input changes
            var detailedChangeBuilder = function (method, inputIndex) {
                return function () {
                    // Update the freightmethods model onchange
                    method.percentSmartWay[5 - inputIndex] =
                        Number(event.currentTarget.value);
                    profile.updateDetailedTotals();
                    profile.updateEmissionsDetailed();
                    profile.onEmissionsUpdate();
                };
            };
            // Function builder for when a simple input changes (select)
            var simpleChangeBuilder = function (method) {
                return function () {
                    method.smartWayGeneral = event.currentTarget.value;
                    obj.updateEmissionsSimple();
                    obj.onEmissionsUpdate();
                };
            };

            var optionAdder = function (select) {
                return function (text) {
                    var option = jQuery('<option value="' + this.toString() + '">' + this.toString() +
                        '</option>');
                    select.append(option);
                };
            };


            // One row per type
            for (var t = 0; t < this.methods.length; ++t) {
                var method = this.methods[t];
                if (!method.active || !method) {
                    continue;
                }

                // If it is NON-Smartway only (rail, barge, etc.) then it needs to be readonly
                if (jQuery.inArray(method.type, Model.NonOnlyCarriers) !== -1) {
                    if (this.doDetailed) {
                        jQuery(this.table).append(detailedNONRowCreator(method));
                    } else {
                        jQuery(this.table).append(simpleNONRowCreator(method));
                    }
                    method.percentSmartWay[5] = 100;
                }
                // Row of six inputs
                else if (this.doDetailed) {
                    var detailedRow = jQuery("<tr></tr>");

                    // Add type header
                    var th = jQuery("<th>" + method.type + "</td>");
                    detailedRow.append(th);

                    // 0,1,2,3,4,5 from best to worst. UI is from worst to best so flip the index with 5-i
                    for (var i = 0; i < 6; ++i) {
                        var td = jQuery("<td></td>");
                        var input = jQuery(
                            '<input type="number" min="0" max="100" maxLength="3" style="width:55px"></input>');
                        // Inverted because theyre stored in the opposite order
                        jQuery(input).val(method.percentSmartWay[5 - i]);

                        input.on('change keyup', detailedChangeBuilder(method, i));
                        td.append(jQuery(input));
                        detailedRow.append(td);
                    }

                    // Blank totals row
                    jQuery(detailedRow).append('<td><b>0</b></td>');

                    jQuery(this.table).append(detailedRow);
                }
                // Simple select
                else {
                    var simpleRow = jQuery("<tr></tr>");

                    // Add type label
                    var thSimple = jQuery("<th>" + method.type + "</th>");
                    simpleRow.append(thSimple);

                    // Select which has the 6 bin options (stored in performancelevels array)
                    var select = jQuery('<select class="form-select"></select>');

                    jQuery.each(performanceLevels, optionAdder(select));

                    select.val(method.smartWayGeneral);
                    var obj = this;
                    select.change(simpleChangeBuilder(method));
                    var selectTD = jQuery("<td></td>");
                    selectTD.append(select);
                    simpleRow.append(selectTD);

                    jQuery(this.table).append(simpleRow);
                }
            }
            if (this.doDetailed) this.updateDetailedTotals();
        };

        this.updateEmissionsSimple = function (factor) {
            for (var i = 0; i < this.methods.length; ++i) {
                var method = this.methods[i];

                if (!method.active) {
                    continue;
                }

                // Do simple calculations with units/type/bin
                var bin = Model.Bins[method.activityUnits][method.type][method.smartWayGeneral];
                var CO2 = bin.CO2;
                var NOX = bin.NOX;
                var PM = bin.PM;
                method.CO2 = CO2 * Number(method.activityQuantity) * factor;
                method.NOX = NOX * Number(method.activityQuantity) * factor;
                method.PM = PM * Number(method.activityQuantity) * factor;
            }
        };

        this.updateEmissionsDetailed = function (factor) {
            for (var i = 0; i < this.methods.length; ++i) {
                var method = this.methods[i];

                // If percentages dont add up, dont re-calculate
                if (method.invalid || !method.active) {
                    continue;
                }

                method.CO2 = 0;
                method.NOX = 0;
                method.PM = 0;
                var activity = method.activityQuantity;
                // Iterate through 6 different percents, do calculation for each
                for (var t = 0; t < method.percentSmartWay.length; ++t) {
                    var binTag = performanceLevels[t];
                    if (jQuery.inArray(method.type, Model.NonOnlyCarriers) !== -1 && binTag !== "NON") continue;
                    var bin = Model.Bins[method.activityUnits][method.type][binTag];

                    var percent = Number(method.percentSmartWay[t]) * 0.01;
                    method.CO2 += Number(activity) * percent * bin.CO2 * factor;
                    method.NOX += Number(activity) * percent * bin.NOX * factor;
                    method.PM += Number(activity) * percent * bin.PM * factor;
                }
            }
        };

        // Update the total levels at the end and the "valid" member of each method
        this.updateDetailedTotals = function () {
            if (!jQuery("#doDetailed").prop("checked")) return;
            if (this.table.childElementCount === 0) {
                return;
            }

            // Get the active ones
            var activeFreightMethods = [];
            jQuery.each(this.methods, function () {
                if (this.active) {
                    activeFreightMethods.push(this);
                }
            });

            // Do totaling
            for (var i = 0; i < activeFreightMethods.length; ++i) {
                var method = activeFreightMethods[i];
                var row = this.table.children("tr:eq(" + i + ")");
                if (!row) continue;

                var td = row.children("th,td").last();

                // Sum all of the percentages
                var sum = method.percentSmartWay.reduce(function (total, num) {
                    return total + num;
                });
                td.html("<b>" + sum + "</b>");
                // If computed value is invalid, mark that on the method for state checks
                if (sum === 100) {
                    method.invalid = false;
                } else {
                    method.invalid = true;
                }
                jQuery(row).append(td);
            }
        };
    }


    // Class which handles the UI/input for activity quantity input, including adding new activities
    function ActivityInputUI(location, onProfileChanged, methods,
        typeChange, typeSet, unitsChange, quantityChange) {
        this.locationID = location;
        this.onProfileChanged = onProfileChanged;
        this.methods = methods;

        this.typeChange = typeChange;
        this.unitsChange = unitsChange;
        this.quantityChange = quantityChange;
        this.typeSet = typeSet; // For when the type is set for the FIRST TIME ONLY
        this.promptText = "--- Select Carrier Type ---";
        this.addQuantityInputUI = function () {
            var obj = this;

            var jQuerytypeSelect = jQuery('<select class="form-select"></select>');
            var methods = this.methods;
            jQuerytypeSelect.empty().append(function () {
                var output = '<option>' + obj.promptText + '</option>';
                jQuery.each(methods, function () {
                    output += "<option>" + this.type + "</option>";
                });
                return output;
            });
            // Four times <td></td> for <Type, Quant, Units, Remove>
            jQuery(this.locationID).append("<tr><th></th><td></td><td></td><td></td></tr>");
            jQuery(this.locationID).find('tr').last().find('th').first().append(jQuerytypeSelect);
            jQuerytypeSelect.attr("haschanged", "false");
            jQuerytypeSelect.change(function () {
                obj.onTypeChanged(this);
                jQuery(this).attr("haschanged", "true");
            });
            jQuerytypeSelect.attr("name", "type");

            // Quantity number input
            var jQueryquantityInput = jQuery('<input type="number" min="0" value="0" name="quantity"/>');
            jQueryquantityInput.on('change keyup', function () {
                obj.onQuantityChanged(this);
            });

            // Select for the units
            var jQueryunitsInput =
                jQuery('<select class="form-select">' +
                    '<option value="Miles">Miles</option>' +
                    '<option value="Ton-Miles">Ton-Miles</option>');
            jQueryunitsInput.change(function () {
                obj.onUnitsChanged(this);
            });
            jQueryunitsInput.attr("name", "units");

            var jQueryremoveInput = jQuery('<input type="button" value="X"/>');
            jQueryremoveInput.click(function () {
                obj.onRemove(this);
            });

            var row = jQuery(this.locationID).find('tr').last();
            jQuery(row).find('td:eq(0)').append(jQuery(jQueryquantityInput));
            jQuery(row).find('td:eq(1)').append(jQuery(jQueryunitsInput));
            jQuery(row).find('td:eq(2)').append(jQuery(jQueryremoveInput));

            this.updateSelectOptions();
            //jQuerytypeSelect.trigger('change');
        };

        this.getTypeByElement =
            function (input) {
                return jQuery(input).parent().parent().find('select').first().val();
            };

        // Fires when the type select value changes
        this.onTypeChanged =
            function (element, wasManual) {
                jQuery("body").css("cursor", "progress");
                // Clear all active methods
                jQuery.each(methods, function () {
                    this.active = false;
                    this.activityQuantity = 0;
                });
                var obj = this;

                // Update which types are active, and update their activityQuantity values
                jQuery(this.locationID).find('select[name=type]').each(function () {
                    var type = jQuery(this).val();
                    var method = jQuery.grep(obj.methods, (function (x) {
                        return (x.type === type);
                    }))[0];
                    if (!method) return;
                    method.active = true;
                    method.activityQuantity = jQuery(this).parent().parent()
                        .find('input[name=quantity]').first().val();

                    obj.methods.splice(obj.methods.indexOf(method), 1);
                    obj.methods.push(method);
                });
                this.updateSelectOptions();

                if (!wasManual) {
                    this.typeChange(jQuery(element).parent().parent().index(), jQuery(element).val());
                    this.onProfileChanged();

                    if (jQuery(element).attr("haschanged") === "false") {
                        if (this.typeSet)
                            this.typeSet();
                    }
                } else if (wasManual)
                    jQuery(element).attr("haschanged", "true");

                jQuery("body").css("cursor", "default");
            };

        // A manual type set which updates the UI and the method
        this.setType =
            function (index, val) {

                var element = jQuery(this.locationID + " > tr:eq(" + index + ")")
                    .find("select[name=type]").first();
                element.val(val);
                this.onTypeChanged(element, true);
            };

        // A manual units set which updates the UI and the method
        this.setUnits =
            function (index, val) {
                var element = jQuery(this.locationID + " > tr:eq(" + index + ")")
                    .find("select[name=units]").first();
                element.val(val);
                this.onUnitsChanged(element, true);
            };

        // A manual quantity set which updates the UI and the method
        this.setQuantity =
            function (index, val) {
                var element = jQuery(this.locationID + " > tr:eq(" + index + ")")
                    .find("input[type=number]").first();
                element.val(val);
                this.onQuantityChanged(element, true);
            };


        // Remove the active methods as, keeping people from selecting twice for current or twice for target
        this.updateSelectOptions =
            function () {
                var profile = this;
                var availableOptions = [];
                jQuery.each(profile.methods, function () {
                    if (!this.active) availableOptions.push(this.type);
                });
                jQuery(this.locationID).find('select[name=type]').each(function () {
                    var value = jQuery(this).val();
                    // Remove the prompt text if it was not selected again
                    if (jQuery(this).children("option").first().val() === profile.promptText && value !==
                        profile.promptText) {
                        jQuery(this).children("option").first().remove();
                    }

                    jQuery(this).children('option').each(function () {
                        if (jQuery(this).val() === value || jQuery.inArray(jQuery(this).val(),
                                availableOptions) !== -1) {
                            // Change the order because hiding it pushs it to the end
                            var methods = createFreightMethods();
                            var index = -1;
                            for (var i = 0; i < methods.length; ++i)
                                if (methods[i].type === jQuery(this).val())
                                    index = i;

                            if (index !== 0)
                                // This fixes some reordering that goes on, but not entirely
                                jQuery(this).insertBefore(jQuery(this).parent().find('option:eq(' +
                                    index + ')'));
                            jQuery(this).show();
                        } else {
                            jQuery(this).hide();
                        }
                    });
                });
            };

        this.onUnitsChanged =
            function (element, wasManual) {
                jQuery("body").css("cursor", "progress");
                var type = this.getTypeByElement(event.currentTarget);
                var method = jQuery.grep(this.methods, function (x) {
                    return x.type === type;
                })[0];
                if (method)
                    method.activityUnits = event.currentTarget.value;
                if (!wasManual) {
                    if (this.unitsChange) this.unitsChange(
                        jQuery(element).parent().parent().index(),
                        jQuery(element).val());
                    this.onProfileChanged();
                }
                jQuery("body").css("cursor", "default");
            };

        this.onQuantityChanged =
            function (element, wasManual) {
                jQuery("body").css("cursor", "progress");
                var jQueryinput = jQuery(event.currentTarget);
                var type = this.getTypeByElement(jQueryinput);
                var quantity = jQueryinput.val();

                var method = jQuery.grep(this.methods, function (x) {
                    return x.type === type;
                })[0];
                if (method) method.activityQuantity = quantity;
                if (!wasManual) {
                    if (this.quantityChange) {
                        this.quantityChange(
                            jQuery(element).parent().parent().index(),
                            jQuery(element).val());
                    }
                    this.onProfileChanged();
                }
                jQuery("body").css("cursor", "default");
            };

        // When the remove button is clicked
        this.onRemove =
            function (element) {
                var type = this.getTypeByElement(event.currentTarget);
                if (type === this.promptText) {
                    return;
                }
                var method = jQuery.grep(this.methods, function (x) {
                    return x.type === type;
                })[0];
                if (method) {
                    method.activityQuantity = 0;
                    method.percentSmartWay = [0, 0, 0, 0, 0, 0];
                    method.active = false;
                }

                this.updateSelectOptions();
                jQuery(element).parent().parent().remove();
                this.onProfileChanged();
            };
    }

    // Graph in the location div
    function BarChart(locationID, title, subtitle, xAxisLabels, yAxisTitle, units, series, pointFormatter) {
        Highcharts.chart(locationID, {
            chart: {
                type: 'column'
            },
            exporting: {
                enabled: true
            },
            title: {
                text: title
            },
            subtitle: {
                text: subtitle
            },
            xAxis: {
                categories: xAxisLabels
            },
            yAxis: {
                title: {
                    text: '<b>' + yAxisTitle + ' (' + units + ')' + '</b>'
                }
            },
            tooltip: {
                // White
                backgroundColor: '#ffffff',
                headerFormat: '',
                pointFormatter: pointFormatter,
                followPointer: true
            },
            plotOptions: {
                series: {
                    allowPointSelect: true
                },
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0,
                    dataLabels: {
                        enabled: true,
                        formatter: function () {
                            return (format(this.y)) + ' ' + units;
                        }
                    }
                }
            },
            series: series
        });
    }


    // Globals for four different input forms
    var currentPerformance;
    var currentActivity;
    var targetPerformance;
    var targetActivity;

    jQuery(document).ready(function () {

        // Start loading the json data right away
        jQuery.getJSON("/sites/staging/files/2018-07/smartway_bins_formatted_0.json", function (data) {
            Model.Bins = data;

            // The begin button, here so that the user cannot continue without the bins
            jQuery("#hideIntro").click(function () {
                if (jQuery("#doDetailed:checked").length > 0) {
                    jQuery("#introDiv").hide();
                    jQuery("#detailedHeader").show();
                    jQuery("#appDiv").show();
                    updateEmissions();
                    window.scrollTo(0, 0);
                } else if (jQuery("#doBasic:checked").length > 0) {
                    jQuery("#introDiv").hide();
                    jQuery("#basicHeader").show();
                    jQuery("#appDiv").show();
                    updateEmissions();
                    window.scrollTo(0, 0);
                } else {
                    alert("Please choose either basic or detailed Bin rankings!");
                }
            });
        });

        /*
        Events fired by current performance when it changes, so that the target activities can be updated
        */
        var onCurrentTypeSet = function (index, val) {
            targetActivity.setType(index, val);
        };
        var onCurrentUnitsSet = function (index, val) {
            targetActivity.setUnits(index, val);
        };
        var onCurrentQuantitySet = function (index, val) {
            targetActivity.setQuantity(index, val);
        };

        // Object handling input for the CURRENT performance rankings
        currentPerformance = new PerformanceInputUI(Model.CurrentCarriers,
            "#currentPerformanceTable", "#currentSimpleHeader",
            "#currentDetailedHeader", updateEmissions);
        // Object handling input for the CURRENT activity
        // For CURRENT the event handlers like settype update the target model, for a one-way sync
        currentActivity = new ActivityInputUI("#currentQuantityTable",
            onActivityChanged, Model.CurrentCarriers,
            onCurrentTypeSet, addCurrentActivity, onCurrentUnitsSet, onCurrentQuantitySet
        );

        // Object handling input for all of the TARGET performance rankings
        targetPerformance = new PerformanceInputUI(Model.TargetCarriers,
            "#targetPerformanceTable", "#targetSimpleHeader", "#targetDetailedHeader", updateEmissions);
        // Object handling input for all of the TARGET activity
        targetActivity = new ActivityInputUI("#targetQuantityTable",
            onActivityChanged, Model.TargetCarriers,
            function () {}, addTargetActivity); // No syncing types for target values, for modal shift/usability reasons

        // Adds events for the tablinks to show the different tabs
        //  -Given id for parent div, tablinks parent, and name of tablinks
        var setupTabs = function (parentDiv, tabsNav, tablinksName) {
            jQuery(parentDiv + ' > div').hide(); // hide all child divs
            jQuery(parentDiv + ' div:first').show(); // show first child div
            jQuery(tabsNav + ' li:first').addClass('active');

            // Onclick for showing and hiding tabs
            jQuery('.menu-internal[name="' + tablinksName + '"]').click(function () {
                var targetTab = jQuery(this).attr('href');
                var currentTab = jQuery(tabsNav + ' > li.active > a').attr("href");
                if (!validateState(currentTab))
                    return;
                jQuery(tabsNav + ' li').removeClass('active');
                // Highlight the tablink
                jQuery(tabsNav + ' li a[href="' + targetTab + '"]').parent().addClass('active');
                jQuery(parentDiv + ' > div').hide();
                // Show the tab
                jQuery(targetTab).show();

                // Fix for issues with graphs not filling their areas
                jQuery("#graph-1").highcharts().reflow();
                jQuery("#graph-2").highcharts().reflow();
                jQuery("#graph-3").highcharts().reflow();

                return false;
            });
        };
        setupTabs("#tabsDiv", "#inputTabsNav", "inputTab");
        setupTabs("#graphTabs", "#graphTabsNav", "graphTab");

        addCurrentActivity();

        jQuery("#doDetailed").change(onDetailedChange);
        jQuery("#doBasic").change(onDetailedChange);

        // Show the intro div and show the app when Begin is clicked
        jQuery("#appDiv").hide();
        jQuery("#basicHeader").hide();
        jQuery("#detailedHeader").hide();


        // Show the introduction instructions
        jQuery("#showIntro").click(function () {
            window.scrollTo(0, 0);
            jQuery("#introDiv").show();
            jQuery("#appDiv").hide();
            jQuery("#basicHeader").hide();
            jQuery("#detailedHeader").hide();
        });

        // Copy #tables div to new window and print it (no styling)
        jQuery("#printButton").click(function () {
            var printWindow = window.open('', 'PRINT', 'height=400,width=600');

            // Open a new window and put in the report for printing
            printWindow.document.write('<html><head><title>' + document.title + '</title>');
            printWindow.document.write('</head><body >');
            printWindow.document.write('<h1>' + document.title + '</h1>');
            printWindow.document.write(jQuery("#tables").html());
            printWindow.document.write('</body></html>');

            printWindow.document.close(); // necessary for IE >= 10
            printWindow.focus(); // necessary for IE >= 10*/

            printWindow.print();
            printWindow.close();
        });

        jQuery("[id^=pounds]").hide();
        jQuery("#outputUnitsSelect").change(setTableUnits);
    });

    function validateState(tabID) {
        var methods;
        // Get the methods model relevant to the current tab
        switch (tabID) {
            // Current activity tab
            case "#tab-1":
                methods = Model.CurrentCarriers;
                break;
                // Target activity tab
            case "#tab-2":
                methods = Model.TargetCarriers;
                break;
        }
        if (!methods)
            return true;

        var failed = false;
        // Check each method for issues and inform the user if there are any
        jQuery.each(methods, function () {
            if (!this.active || failed)
                return;

            else if (Number(this.activityQuantity) <= 0) {
                alert("One of your Current Activity Quantities is Zero or Invalid!");
                failed = true;
            } else if (jQuery("#doDetailed").prop("checked") && this.invalid) {
                alert("One of your Current Activty Bins (%) does not add up to 100!");
                failed = true;
            }
        });

        return (!failed);
    }


    // Update all of the emissions calculations and UI
    function updateEmissions() {
        updateEmissionsCalculations();
        updateCurrentEmissionsUI();
        updateGoalEmissionsUI();
        updateGraphs();
    }

    // Set the units of headers for all the tables based on what is selected
    // Accomplished by hiding unused headers and showing used ones
    function setTableUnits() {
        var value = jQuery("#outputUnitsSelect").val();
        if (value === "Metric (kg)") {
            jQuery("[id^=kg]").show();
            jQuery("[id^=pounds]").hide();
        } else if (value === "US (lb)") {
            jQuery("[id^=kg]").hide();
            jQuery("[id^=pounds]").show();
        }
    }

    // When the detailed checkbox changes
    function onDetailedChange() {
        var detailed = jQuery("#doDetailed").prop('checked');
        currentPerformance.setDetailed(detailed);
        targetPerformance.setDetailed(detailed);
    }

    // Update the target/current performance input fields
    function updatePerformanceInputUI() {
        currentPerformance.updateInputUI();
        targetPerformance.updateInputUI();
    }

    // For output number formatting
    function roundToTwo(num) {
        return +(Math.round(num + "e+2") + "e-2");
    }

    // When the add button for current activity input is clicked
    function addCurrentActivity() {
        currentActivity.addQuantityInputUI();
        if (jQuery("#currentQuantityTable > tr").length > jQuery("#targetQuantityTable > tr").length)
            addTargetActivity();
    }
    // When the add button for target activity input is clicked
    function addTargetActivity() {
        targetActivity.addQuantityInputUI();
    }

    // When the activity input, target or current, changes. Fired by activityprofiles
    function onActivityChanged() {
        updatePerformanceInputUI();
        updateEmissions();
    }

    function format(number) {
        return roundToTwo(number).toLocaleString();
    }

    // Update the table for emissions
    function updateCurrentEmissionsUI() {

        var activeFreightMethods = [];
        // Get active methods from all current freightmethods
        jQuery.each(Model.CurrentCarriers, function () {
            if (this.active) activeFreightMethods.push(this);
        });

        jQuery("#currentTable").empty();
        jQuery("#currentTable1").empty();

        var currentCO2 = 0;
        var currentNOX = 0;
        var currentPM = 0;
        // Add row for emissions for each type
        for (var i = 0; i < activeFreightMethods.length; ++i) {
            var method = activeFreightMethods[i];
            var tableRow = createTableRow(
                createTableCell(method.type),
                createTableCell(format(method.CO2)),
                createTableCell(format(method.NOX)),
                createTableCell(format(method.PM)));

            jQuery(tableRow).appendTo("#currentTable,#currentTable1");
            currentCO2 += method.CO2;
            currentNOX += method.NOX;
            currentPM += method.PM;
        }

        // Create a row for totals
        var currentTableRow = createTableRow(
            createTableHeader("TOTAL"),
            createTableHeader(format(currentCO2)),
            createTableHeader(format(currentNOX)),
            createTableHeader(format(currentPM)));
        jQuery(currentTableRow).appendTo("#currentTable,#currentTable1");
    }

    // Update the savings table, including the calculations and totals
    function updateGoalEmissionsUI() {
        jQuery("#targetTable").empty();
        jQuery("#targetTable1").empty();
        jQuery("#savingsTableRaw").empty();
        jQuery("#savingsTablePercent").empty();

        var emissionTypes = ["CO2", "NOX", "PM"];
        var EmissionsGroup = function () {
            this.CO2 = 0;
            this.NOX = 0;
            this.PM = 0;
        };
        var currentTotal = new EmissionsGroup();
        var targetTotal = new EmissionsGroup();
        var savedTotal = new EmissionsGroup();

        // Function builder for checking if methods are the same type, used in grep search
        var isSameType = function (val) {
            return function (val2) {
                return val.type === val2.type;
            };
        };

        var cellPopulator = function (currentMethod, targetMethod,
            targetCells, savedCells, percentCells) {
            return function () {
                var emis = this.toString();
                currentTotal[emis] += currentMethod[emis];
                targetTotal[emis] += targetMethod[emis];
                var saved = (currentMethod[emis] - targetMethod[emis]);
                savedTotal[emis] += saved;

                targetCells.push(createTableCell(format(targetMethod[emis])));
                savedCells.push(createTableCell(format(saved)));

                // Add percentage to row, can't divide by zero
                if (currentMethod[emis] > 0) {
                    percentCells.push(createTableCell(format(
                        (saved / currentMethod[emis]) * 100)));
                } else percentCells.push(createTableCell("0"));
            };
        };

        var appender = function (element) {
            return function () {
                jQuery(this).appendTo(element);
            };
        };

        // Go through each method to calculate savings
        for (var i = 0; i < Model.CurrentCarriers.length; ++i) {

            var currentMethod = Model.CurrentCarriers[i];

            // Find the first "targetmethod" with same ID
            var targetMethod = jQuery.grep(Model.TargetCarriers,
                isSameType(currentMethod))[0];

            if (!currentMethod.active && !targetMethod.active) {
                continue;
            }

            // Each of the rows for target, saved, and percent tables (current is elsewhere)
            var targetCells = [createTableCell(targetMethod.type)];
            var savedCells = [createTableCell(targetMethod.type)];
            var percentCells = [createTableCell(targetMethod.type)];

            // Update all of the totals and add to the cells list for this row
            jQuery.each(emissionTypes, cellPopulator(currentMethod, targetMethod,
                targetCells, savedCells, percentCells));
            var targetRow = jQuery("<tr></tr>");

            jQuery.each(targetCells, appender(targetRow));
            jQuery(targetRow).appendTo("#targetTable,#targetTable1");

            var savedRow = jQuery("<tr></tr>");
            jQuery.each(savedCells, appender(savedRow));
            jQuery(savedRow).appendTo("#savingsTableRaw");

            var percentRow = jQuery("<tr></tr>");
            jQuery.each(percentCells, appender(percentRow));
            jQuery(percentRow).appendTo("#savingsTablePercent");
        }

        var targetTotalCells = [createTableHeader("TOTAL")];
        var savedTotalCells = [createTableHeader("TOTAL")];
        var percentTotalCells = [createTableHeader("TOTAL")];

        // Create a totals row for target
        jQuery.each(emissionTypes, function () {
            var emis = this.toString();
            targetTotalCells.push(createTableHeader(format(targetTotal[emis])));
            savedTotalCells.push(createTableHeader(format(savedTotal[emis])));
            if (targetTotal[emis] !== 0) {
                percentTotalCells.push(createTableHeader(format(
                    (savedTotal[emis] / currentTotal[emis]) * 100)));
            } else {
                percentTotalCells.push(createTableHeader(format("0")));
            }
        });

        /*
        Append to all the tables
        */

        var targetTotalRow = jQuery("<tr></tr>");
        jQuery.each(targetTotalCells, function () {
            jQuery(this).appendTo(targetTotalRow);
        });
        jQuery(targetTotalRow).appendTo("#targetTable,#targetTable1");

        var savedTotalRow = jQuery("<tr></tr>");
        jQuery.each(savedTotalCells, function () {
            jQuery(this).appendTo(savedTotalRow);
        });
        jQuery(savedTotalRow).appendTo("#savingsTableRaw");

        var percentTotalRow = jQuery("<tr></tr>");
        jQuery.each(percentTotalCells, function () {
            jQuery(this).appendTo(percentTotalRow);
        });
        jQuery(percentTotalRow).appendTo("#savingsTablePercent");
    }

    // Show the graphs with raw data, no percentages etc
    function updateGraphs() {

        var units = "KiloGrams";
        var unitsShort = "kg";
        if (jQuery("#outputUnitsSelect").val() === "US (lb)") {
            units = "Pounds";
            unitsShort = "lb";
        }

        var active = [];
        // Fill active list if not already there
        var getActive = function () {
            if (this.active && (jQuery.inArray(this.type, active) === -1)) active.push(this.type);
        };

        // Collect all active models, no duplicates, from both lists
        jQuery.each(Model.CurrentCarriers, getActive);
        jQuery.each(Model.TargetCarriers, getActive);
        var yTitle = "Emissions";

        // Create the series for each pollutant
        function createAllSeries(pollutant) {
            var series = [];
            jQuery.each(active, function () {
                var val = this.toString();
                var current =
                    // finds the first method matching the query
                    jQuery.grep(Model.CurrentCarriers,
                        function (x) {
                            return x.type === val;
                        })[0][pollutant];

                var target =
                    // finds the first method matching the query
                    jQuery.grep(Model.TargetCarriers,
                        function (x) {
                            return x.type === val;
                        })[0][pollutant];

                var saved = (current - target);

                series.push({
                    name: val,
                    data: [current, target, saved]
                });
            });

            return series;
        }
        var CO2 = createAllSeries("CO2");
        var NOX = createAllSeries("NOX");
        var PM = createAllSeries("PM");

        // Formatter for the tooltip, constructs the box for when you mouse over the graph
        var pointFormatter = function () {
            var values = this.series.data;
            var percentage = (values[2].y / values[0].y) * 100;
            var string = '<b><span>' + this.series.name + ': </span>' +
                format(this.y) + ' ' + unitsShort + '</b>';
            if (this.x === 2)
                string += "<b>| " + format(percentage) + " %</b>";
            return string;
        };
        BarChart("graph-1", "CO2", "Estimated Emissions in " + units, ["<b>Current</b>", "<b>Target</b>",
                "<b>Savings</b>"
            ],
            yTitle, unitsShort, CO2, pointFormatter);
        BarChart("graph-2", "NOX", "Estimated Emissions in " + units, ["<b>Current</b>", "<b>Target</b>",
                "<b>Savings</b>"
            ],
            yTitle, unitsShort, NOX, pointFormatter);
        BarChart("graph-3", "PM 2.5", "Estimated Emissions in " + units, ["<b>Current</b>", "<b>Target</b>",
            "<b>Savings</b>"
        ], yTitle, unitsShort, PM, pointFormatter);
    }

    // Call the profiles calculation functions (also update the bins that they use, for redundancy)
    function updateEmissionsCalculations() {
        var outputEmissionsUnit = jQuery("#outputUnitsSelect").val();

        // The conversion factor all emissions are multplied by. Original is grams
        var factor = 1;
        if (outputEmissionsUnit === "US (lb)") { // g -> lb
            factor = (1 / 453.592);
        } else if (outputEmissionsUnit === "Metric (kg)") { // g -> kg
            factor = (1 / 1000);
        }

        if (jQuery("#doDetailed:checked").length > 0) {
            currentPerformance.updateEmissionsDetailed(factor);
            targetPerformance.updateEmissionsDetailed(factor);
        } else {
            currentPerformance.updateEmissionsSimple(factor);
            targetPerformance.updateEmissionsSimple(factor);
        }
    }
</script>